@Master['Views/Master']

@Section['css']
<link href="/css/navbar-fixed-top.css" rel="stylesheet">
<link href="/css/list.css" rel="stylesheet">
@EndSection

@Section['Content']

<!--header-->
@Partial['Views/MenuBar'];

<div class="container">

    <h1 class="page-header">@Model.Task.Name</h1>
    <h2>Progress</h2>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: @Model.Progress;%;">
        @Model.Progress;%
      </div>
    </div>

    <div class="row">
      <div class="col-md-8">
        @Each.Task.Comments
          <div class="row">
            <div class="col-md-12 comment">
              @Current.Text
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <p class="text-muted text-right">@Current.Who.Name; @Current.Day.Month;/@Current.Day.Day; @Current.Day.Hour;:@Current.Day.Minute;</p>
            </div>
          </div>
        @EndEach

        <div class="row">
          <textArea id="commentText" class="col-md-12" Rows="8"></textarea>
        </div>
        <div class="row">
          <button id="addComment" class="btn btn-default pull-right" >Add Comment</button>
        </div>
      </div>
      <div class="col-md-4">
        @Each.Task.Records
          <div class="row">
            <div class="col-md-1">
              @Current.Day
            </div>
            <div class="col-md-1">
              @Current.Who.Name
            </div>
            <div class="col-md-1">
              @Current.Value
            </div>
            <div class="col-md-1">
              @Current.WorkValue
            </div>
          </div>
        @EndEach
        <textArea id="record" ></textarea>
        <a id="addrecord" class="btn btn-default pull-right" >Add Record</a>
      </div>
    </div>
</div>
@EndSection

@Section['js']
<script type="text/javascript">
  $(function () {

    $('.comment').each(function(){
      var text = $(this).html();
      text = $.trim(text);
      text = text.replace(/\r\n/g, "<br />");
      text = text.replace(/(\n|\r)/g, "<br />");
      $(this).html(text);
    });

    $('#addComment').click(function(e){

      var dt = new Date();
      var now = dt.toLocaleDateString() + " " + dt.toLocaleTimeString();

      var jsonData = {
        taskId:@Model.Task.Id,
        comment : {
          day: now,
          text: $('#commentText').val(),
          who:{
            id:'@Model.Auth.Id',
            name:'@Model.Auth.Name'
          }
        },
      };
      var json = JSON.stringify(jsonData);
      var url = '@Path['~/api/task/comment/']';
      $.ajax({
        type:'post',
        url:url,
        data : json,
        dataType : 'JSON',
        scriptCharset: 'utf-8',
        success : function(data) {
              //location.href = '@Path['~/project/@Model.Project.Id']';
              location.reload();
        },
        error : function(data) {
            // Error
            alert("error");
            alert(JSON.stringify(data));
            $("#response").html(JSON.stringify(data));
        }
      });

    });
  });
</script>
@EndSection
